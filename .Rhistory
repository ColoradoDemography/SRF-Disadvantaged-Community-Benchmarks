select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)%>%
mutate(debt=GO_DEBT+REVENUE_DEBT+OTHER_DEBT)%>%
group_by(LG_ID, NAME, AUDIT_YEAR)%>%
summarize(debt=sum(debt))
View(s4debt_ws)
s4debt_ws=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)%>%
mutate(debt=GO_DEBT+REVENUE_DEBT+OTHER_DEBT)%>%
group_by(LG_ID, NAME, AUDIT_YEAR)%>%
summarize(debt=sum(debt))%>%
ungroup()%>%
group_by(LG_ID, NAME)%>%
summarize(debt=mean(debt))
s4debt_sep=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(2,3), LGTYPE_ID%in%c(2,3,4,5, 61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)%>%
mutate(debt=GO_DEBT+REVENUE_DEBT+OTHER_DEBT)%>%
group_by(LG_ID, NAME, CM_FUND_TYPE_ID)%>%
summarize(debt=mean(debt))%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, debt)
View(y)
s4_data_ws=hu4%>%
inner_join(mhv4, by="LG_ID")%>%
filter(!is.na(LG_ID))%>%
inner_join(s4debt_ws, by="LG_ID")%>%
mutate(s4metric=debt/housingunits/mhv
)
View(s4_data_ws)
s4_data_sep=hu4%>%
inner_join(mhv4, by="LG_ID")%>%
filter(!is.na(LG_ID))%>%
inner_join(s4debt_sep, by="LG_ID")%>%
mutate(s4metric=debt/housingunits/mhv)
View(s4debt_sep)
View(s4_data_sep)
View(s5a_benchmark_ws)
View(s5b_benchmark_sep)
fti=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)
fti=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID,NAME, AUDIT_YEAR, CM_FUND_TYPE_ID)%>%
mutate(type=ifelse(CM_FUND_TYPE_ID==1, "combined",
ifelse(CM_FUND_TYPE_ID==2, "water_only", "sewer_only")))
View(fti)
fti=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID,NAME, AUDIT_YEAR, CM_FUND_TYPE_ID)%>%
mutate(type=ifelse(CM_FUND_TYPE_ID==1, "combined",
ifelse(CM_FUND_TYPE_ID==2, "water_only", "sewer_only")),
indicator=1)%>%
spread(type,indicator)
View(fti)
fti=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID,NAME, AUDIT_YEAR, CM_FUND_TYPE_ID)%>%
mutate(type=ifelse(CM_FUND_TYPE_ID==1, "combined",
ifelse(CM_FUND_TYPE_ID==2, "water_only", "sewer_only")))%>%
spread(type,CM_FUND_ID)
fti=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID,NAME, AUDIT_YEAR, CM_FUND_TYPE_ID)%>%
mutate(type=ifelse(CM_FUND_TYPE_ID==1, "combined",
ifelse(CM_FUND_TYPE_ID==2, "water_only", "sewer_only")))%>%
spread(type,CM_FUND_TYPE_ID)
View(fti)
fti=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID,NAME, AUDIT_YEAR, CM_FUND_TYPE_ID)%>%
mutate(type=ifelse(CM_FUND_TYPE_ID==1, "combined",
ifelse(CM_FUND_TYPE_ID==2, "water_only", "sewer_only")))%>%
spread(type,CM_FUND_TYPE_ID)%>%
mutate(ws_include=ifelse(combined==1, 1,
ifelse(!is.na(water_only) & !is.na(sewer_only), 1, 0)))
View(fti)
fti=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID,NAME, AUDIT_YEAR, CM_FUND_TYPE_ID)%>%
mutate(type=ifelse(CM_FUND_TYPE_ID==1, "combined",
ifelse(CM_FUND_TYPE_ID==2, "water_only", "sewer_only")))%>%
spread(type,CM_FUND_TYPE_ID)%>%
mutate(sum=sum(combined,water_only,sewer_only, na.rm=TRUE)
)
View(fti)
fti=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID,NAME, AUDIT_YEAR, CM_FUND_TYPE_ID)%>%
mutate(type=ifelse(CM_FUND_TYPE_ID==1, "combined",
ifelse(CM_FUND_TYPE_ID==2, "water_only", "sewer_only")))%>%
spread(type,CM_FUND_TYPE_ID)%>%
mutate(sum=sum(combined,water_only,sewer_only))
View(fti)
fti=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID,NAME, AUDIT_YEAR, CM_FUND_TYPE_ID)%>%
mutate(type=ifelse(CM_FUND_TYPE_ID==1, "combined",
ifelse(CM_FUND_TYPE_ID==2, "water_only", "sewer_only")))%>%
spread(type,CM_FUND_TYPE_ID)%>%
mutate(sum=ifelse(is.na(combined), water_only+sewer_only, combined))
View(fti)
fti=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID,NAME, AUDIT_YEAR, CM_FUND_TYPE_ID)%>%
mutate(type=ifelse(CM_FUND_TYPE_ID==1, "combined",
ifelse(CM_FUND_TYPE_ID==2, "water_only", "sewer_only")))%>%
spread(type,CM_FUND_TYPE_ID)%>%
mutate(sum=ifelse(is.na(combined), water_only+sewer_only, combined),
ws_include=ifelse(is.na(sum), 0, 1))
View(fti)
fti=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID,NAME, AUDIT_YEAR, CM_FUND_TYPE_ID)%>%
mutate(type=ifelse(CM_FUND_TYPE_ID==1, "combined",
ifelse(CM_FUND_TYPE_ID==2, "water_only", "sewer_only")))%>%
spread(type,CM_FUND_TYPE_ID)%>%
mutate(sum=ifelse(is.na(combined), water_only+sewer_only, combined),
ws_include=ifelse(is.na(sum), 0, 1))%>%
select(LG_ID, NAME, ws_include)
s4debt_ws=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
inner_join(fti, by="LG_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014, ws_include==1)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)%>%
mutate(debt=GO_DEBT+REVENUE_DEBT+OTHER_DEBT)%>%
group_by(LG_ID, NAME, AUDIT_YEAR)%>%
summarize(debt=sum(debt))%>%
ungroup()%>%
group_by(LG_ID, NAME)%>%
summarize(debt=mean(debt))
s4debt_sep=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(2,3), LGTYPE_ID%in%c(2,3,4,5, 61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)%>%
mutate(debt=GO_DEBT+REVENUE_DEBT+OTHER_DEBT)%>%
group_by(LG_ID, NAME, CM_FUND_TYPE_ID)%>%
summarize(debt=mean(debt))%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, debt)
##LIST OF PLACE NOT IN THERE
y=anti_join(s3_data, s4debt, by="LG_ID")
hu4=housingunits%>%
filter(year>=2010, year<=2014)%>%
select(LG_ID, year, totalhousingunits)%>%
group_by(LG_ID)%>%
summarize(housingunits=mean(as.numeric(totalhousingunits)))
mhv4=codemog_api(data="b25077", db="acs1115", sumlev = "160", geography = "sumlev")%>%
mutate(place=as.numeric(place),
mhv=as.numeric(b25077001))%>%
left_join(oisplace, c("place"= "PLACE"))
s4_data_ws=hu4%>%
inner_join(mhv4, by="LG_ID")%>%
filter(!is.na(LG_ID))%>%
inner_join(s4debt_ws, by="LG_ID")%>%
mutate(s4metric=debt/housingunits/mhv)
# s4metric=ifelse(is.na(s4metric), 0,s4metric))
s4_data_sep=hu4%>%
inner_join(mhv4, by="LG_ID")%>%
filter(!is.na(LG_ID))%>%
inner_join(s4debt_sep, by="LG_ID")%>%
mutate(s4metric=debt/housingunits/mhv)
# s4metric=ifelse(is.na(s4metric), 0,s4metric))
s4_benchmark_ws=data.frame(s4_benchmark_ws=median(s4_data_ws$s4metric))
s4_benchmark_sep=s4_data_sep%>%
mutate(fundID=ifelse(CM_FUND_TYPE_ID==2, "w", "s"),
name=paste0("s4_benchmark_", fundID))%>%
group_by(name)%>%
summarize(s4_benchmark_sep=median(s4metric, na.rm=TRUE))%>%
spread(name, s4_benchmark_sep)
View(s4_benchmark_ws)
s4debt_ws=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
inner_join(fti, by="LG_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014, ws_include==1)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)%>%
mutate(debt=GO_DEBT+REVENUE_DEBT+OTHER_DEBT)%>%
group_by(LG_ID, NAME, AUDIT_YEAR)%>%
summarize(debt=sum(debt))%>%
ungroup()%>%
group_by(LG_ID, NAME)%>%
summarize(debt=mean(debt))
s4debt_ws=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
inner_join(fti, by="LG_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014, ws_include==1)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)
s4debt_ws=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
inner_join(fti, by="LG_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014, ws_include==1)
View(s4debt_ws)
s4debt_ws=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")
View(fti)
fti=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID,NAME, AUDIT_YEAR, CM_FUND_TYPE_ID)%>%
mutate(type=ifelse(CM_FUND_TYPE_ID==1, "combined",
ifelse(CM_FUND_TYPE_ID==2, "water_only", "sewer_only")))%>%
spread(type,CM_FUND_TYPE_ID)%>%
mutate(sum=ifelse(is.na(combined), water_only+sewer_only, combined),
ws_include=ifelse(is.na(sum), 0, 1))%>%
select(LG_ID, ws_include)
s4debt_ws=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
inner_join(fti, by="LG_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014, ws_include==1)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)%>%
mutate(debt=GO_DEBT+REVENUE_DEBT+OTHER_DEBT)%>%
group_by(LG_ID, NAME, AUDIT_YEAR)%>%
summarize(debt=sum(debt))%>%
ungroup()%>%
group_by(LG_ID, NAME)%>%
summarize(debt=mean(debt))
s4debt_sep=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(2,3), LGTYPE_ID%in%c(2,3,4,5, 61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)%>%
mutate(debt=GO_DEBT+REVENUE_DEBT+OTHER_DEBT)%>%
group_by(LG_ID, NAME, CM_FUND_TYPE_ID)%>%
summarize(debt=mean(debt))%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, debt)
##LIST OF PLACE NOT IN THERE
y=anti_join(s3_data, s4debt, by="LG_ID")
hu4=housingunits%>%
filter(year>=2010, year<=2014)%>%
select(LG_ID, year, totalhousingunits)%>%
group_by(LG_ID)%>%
summarize(housingunits=mean(as.numeric(totalhousingunits)))
mhv4=codemog_api(data="b25077", db="acs1115", sumlev = "160", geography = "sumlev")%>%
mutate(place=as.numeric(place),
mhv=as.numeric(b25077001))%>%
left_join(oisplace, c("place"= "PLACE"))
s4_data_ws=hu4%>%
inner_join(mhv4, by="LG_ID")%>%
filter(!is.na(LG_ID))%>%
inner_join(s4debt_ws, by="LG_ID")%>%
mutate(s4metric=debt/housingunits/mhv)
# s4metric=ifelse(is.na(s4metric), 0,s4metric))
s4_data_sep=hu4%>%
inner_join(mhv4, by="LG_ID")%>%
filter(!is.na(LG_ID))%>%
inner_join(s4debt_sep, by="LG_ID")%>%
mutate(s4metric=debt/housingunits/mhv)
# s4metric=ifelse(is.na(s4metric), 0,s4metric))
s4_benchmark_ws=data.frame(s4_benchmark_ws=median(s4_data_ws$s4metric))
View(s4_benchmark_ws)
View(s4_data_ws)
s4debt_ws=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
inner_join(fti, by="LG_ID")
names(s4debt_ws)
s4debt_ws=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
inner_join(fti, by="LG_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014, ws_include==1)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)%>%
mutate(debt=GO_DEBT+REVENUE_DEBT+OTHER_DEBT)%>%
group_by(LG_ID, NAME, AUDIT_YEAR)%>%
summarize(debt=sum(debt))%>%
ungroup()%>%
group_by(LG_ID, NAME)%>%
summarize(debt=mean(debt))
s4debt_sep=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(2,3), LGTYPE_ID%in%c(2,3,4,5, 61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)%>%
mutate(debt=GO_DEBT+REVENUE_DEBT+OTHER_DEBT)%>%
group_by(LG_ID, NAME, CM_FUND_TYPE_ID)%>%
summarize(debt=mean(debt))%>%
select(LG_ID, CM_FUND_TYPE_ID, debt)
View(s4debt_sep)
s4debt_sep=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(2,3), LGTYPE_ID%in%c(2,3,4,5, 61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)%>%
mutate(debt=GO_DEBT+REVENUE_DEBT+OTHER_DEBT)%>%
group_by(LG_ID, NAME, CM_FUND_TYPE_ID)%>%
summarize(debt=mean(debt))%>%
ungroup()%>%
select(LG_ID, CM_FUND_TYPE_ID, debt)
s4debt_ws=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
inner_join(fti, by="LG_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014, ws_include==1)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)%>%
mutate(debt=GO_DEBT+REVENUE_DEBT+OTHER_DEBT)%>%
group_by(LG_ID, NAME, AUDIT_YEAR)%>%
summarize(debt=sum(debt))%>%
ungroup()%>%
group_by(LG_ID, NAME)%>%
summarize(debt=mean(debt))
s4debt_sep=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(2,3), LGTYPE_ID%in%c(2,3,4,5, 61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, GO_DEBT,REVENUE_DEBT,OTHER_DEBT)%>%
mutate(debt=GO_DEBT+REVENUE_DEBT+OTHER_DEBT)%>%
group_by(LG_ID, NAME, CM_FUND_TYPE_ID)%>%
summarize(debt=mean(debt))%>%
ungroup()%>%
select(LG_ID, CM_FUND_TYPE_ID, debt)
##LIST OF PLACE NOT IN THERE
y=anti_join(s3_data, s4debt, by="LG_ID")
hu4=housingunits%>%
filter(year>=2010, year<=2014)%>%
select(LG_ID, year, totalhousingunits)%>%
group_by(LG_ID)%>%
summarize(housingunits=mean(as.numeric(totalhousingunits)))
mhv4=codemog_api(data="b25077", db="acs1115", sumlev = "160", geography = "sumlev")%>%
mutate(place=as.numeric(place),
mhv=as.numeric(b25077001))%>%
left_join(oisplace, c("place"= "PLACE"))
s4_data_ws=hu4%>%
inner_join(mhv4, by="LG_ID")%>%
filter(!is.na(LG_ID))%>%
inner_join(s4debt_ws, by="LG_ID")%>%
mutate(s4metric=debt/housingunits/mhv)
# s4metric=ifelse(is.na(s4metric), 0,s4metric))
s4_data_sep=hu4%>%
inner_join(mhv4, by="LG_ID")%>%
filter(!is.na(LG_ID))%>%
inner_join(s4debt_sep, by="LG_ID")%>%
mutate(s4metric=debt/housingunits/mhv)
# s4metric=ifelse(is.na(s4metric), 0,s4metric))
s4_benchmark_ws=data.frame(s4_benchmark_ws=median(s4_data_ws$s4metric))
View(s4_benchmark_ws)
s4_benchmark_ws=data.frame(s4_benchmark_ws=median(s4_data_ws$s4metric, na.rm = TRUE))
View(s4_benchmark_ws)
s4_benchmark_sep=s4_data_sep%>%
mutate(fundID=ifelse(CM_FUND_TYPE_ID==2, "w", "s"),
name=paste0("s4_benchmark_", fundID))%>%
group_by(name)%>%
summarize(s4_benchmark_sep=median(s4metric, na.rm=TRUE))%>%
spread(name, s4_benchmark_sep)
View(s4_benchmark_sep)
s5acost_ws=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
inner_join(fti, by="LG_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014, ws_include==1)%>%
mutate(cost=EXP_OPERATING+EXP_TRANSFER_OUT+DEPRECIATION)%>%
group_by(LG_ID, NAME, AUDIT_YEAR)%>%
summarize(cost=sum(cost))%>%
ungroup()%>%
group_by(LG_ID, NAME)%>%
summarize(cost=mean(cost))
s5acost_sep=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, EXP_OPERATING,EXP_TRANSFER_OUT,DEPRECIATION)%>%
mutate(cost=EXP_OPERATING+EXP_TRANSFER_OUT+DEPRECIATION)%>%
group_by(LG_ID, NAME, CM_FUND_TYPE_ID)%>%
summarize(cost=mean(cost))%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, cost)
hu5=housingunits%>%
filter(year>=2010, year<=2014)%>%
select(LG_ID, year, totalhousingunits)%>%
group_by(LG_ID)%>%
summarize(housingunits=mean(as.numeric(totalhousingunits)))
mhi5=codemog_api(data="b19013", db="acs1115", sumlev = "160", geography = "sumlev")%>%
mutate(place=as.numeric(place),
mhi=as.numeric(b19013001))%>%
left_join(oisplace, c("place"= "PLACE"))%>%
filter(!is.na(LG_ID))
s5a_data_ws=hu5%>%
inner_join(mhi5, by="LG_ID")%>%
filter(!is.na(LG_ID))%>%
inner_join(s5acost_ws, by="LG_ID")%>%
mutate(s5metric=cost/housingunits/mhi)
# s5metric=ifelse(is.na(s5metric), 0,s5metric))
s5a_data_sep=hu5%>%
inner_join(mhi5, by="LG_ID")%>%
filter(!is.na(LG_ID))%>%
inner_join(s5acost_sep, by="LG_ID")%>%
mutate(s5metric=cost/housingunits/mhi)
# s5metric=ifelse(is.na(s5metric), 0,s5metric))
s5a_benchmark_ws=data.frame(s5a_benchmark_ws=median(s5a_data_ws$s5metric, na.rm = TRUE))
s5a_benchmark_sep=s5a_data_sep%>%
mutate(fundID=ifelse(CM_FUND_TYPE_ID==2, "w", "s"),
name=paste0("s5a_benchmark_", fundID))%>%
group_by(name)%>%
summarize(s5a_benchmark_sep=median(s5metric, na.rm=TRUE))%>%
spread(name, s5a_benchmark_sep)
#### S5b System Required Revenue/Tap/MHI (@110% Coverage) ####
s5brev_ws=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
inner_join(fti, by="LG_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(1,2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014, ws_include==1)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, EXP_OPERATING,EXP_TRANSFER_OUT,EXP_PRINCIPAL, EXP_INTEREST)%>%
mutate(rev=(1.1*(EXP_PRINCIPAL+EXP_INTEREST))+(EXP_OPERATING+EXP_TRANSFER_OUT))%>%
group_by(LG_ID, NAME, AUDIT_YEAR)%>%
summarize(rev=sum(rev))%>%
ungroup()%>%
group_by(LG_ID, NAME)%>%
summarize(rev=mean(rev))
s5brev_sep=lgbasic%>%
select(-CREATED_BY:-OSA)%>%
inner_join(cm_audit, by="LG_ID")%>%
inner_join(select(cm_fund, -CREATED_ON:-UPDATED_BY), by="CM_AUDIT_ID")%>%
filter(CM_FUND_TYPE_ID%in%c(2,3), LGTYPE_ID%in%c(2,3,4,5,61,70), AUDIT_YEAR>=2010, AUDIT_YEAR<=2014)%>%
select(LG_ID, NAME, CM_FUND_TYPE_ID, AUDIT_YEAR, EXP_OPERATING,EXP_TRANSFER_OUT,EXP_PRINCIPAL, EXP_INTEREST)%>%
mutate(rev=(1.1*(EXP_PRINCIPAL+EXP_INTEREST))+(EXP_OPERATING+EXP_TRANSFER_OUT))%>%
group_by(LG_ID, NAME, CM_FUND_TYPE_ID)%>%
summarize(rev=mean(rev))
s5b_data_ws=hu5%>%
inner_join(mhi5, by="LG_ID")%>%
filter(!is.na(LG_ID))%>%
inner_join(s5brev_ws, by="LG_ID")%>%
mutate(s5metric=rev/housingunits/mhi)
# s5metric=ifelse(is.na(s5metric), 0,s5metric))
s5b_data_sep=hu5%>%
inner_join(mhi5, by="LG_ID")%>%
filter(!is.na(LG_ID))%>%
inner_join(s5brev_sep, by="LG_ID")%>%
mutate(s5metric=rev/housingunits/mhi)
# s5metric=ifelse(is.na(s5metric), 0,s5metric))
s5b_benchmark_ws=data.frame(s5b_benchmark_ws=median(s5b_data_ws$s5metric, na.rm = TRUE))
s5b_benchmark_sep=s5b_data_sep%>%
mutate(fundID=ifelse(CM_FUND_TYPE_ID==2, "w", "s"),
name=paste0("s5b_benchmark_", fundID))%>%
group_by(name)%>%
summarize(s5b_benchmark_sep=median(s5metric, na.rm=TRUE))%>%
spread(name, s5b_benchmark_sep)
##### Output #####
benchmarks=bind_cols(s3_benchmark, s4_benchmark_ws, s4_benchmark_sep, s5a_benchmark_ws, s5a_benchmark_sep, s5b_benchmark_ws, s5b_benchmark_sep)
View(benchmarks)
write.csv(benchmarks, "benchmarks_2017.csv", row.names = FALSE)
write.csv(s3_data, "s3_data.csv", row.names = FALSE)
write.csv(s4_data_ws, "s4_data_ws.csv", row.names = FALSE)
write.csv(s4_data_sep, "s4_data_sep.csv", row.names = FALSE)
write.csv(s5a_data_ws, "s5a_data_ws.csv", row.names = FALSE)
write.csv(s5a_data_sep, "s5a_data_sep.csv", row.names = FALSE)
write.csv(s5b_data_ws, "s5b_data_ws.csv", row.names = FALSE)
write.csv(s5b_data_sep, "s5b_data_sep.csv", row.names = FALSE)
