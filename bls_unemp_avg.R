library(blsAPI)
library(tidyverse)

counties=c("LAUST080000000000003","LAUCN080010000000003","LAUCN080030000000003","LAUCN080050000000003","LAUCN080070000000003","LAUCN080090000000003","LAUCN080110000000003","LAUCN080130000000003","LAUCN080140000000003","LAUCN080150000000003","LAUCN080170000000003","LAUCN080190000000003","LAUCN080210000000003","LAUCN080230000000003","LAUCN080250000000003","LAUCN080270000000003","LAUCN080290000000003","LAUCN080310000000003","LAUCN080330000000003","LAUCN080350000000003","LAUCN080370000000003","LAUCN080390000000003","LAUCN080410000000003","LAUCN080430000000003","LAUCN080450000000003","LAUCN080470000000003","LAUCN080490000000003","LAUCN080510000000003","LAUCN080530000000003","LAUCN080550000000003","LAUCN080570000000003","LAUCN080590000000003","LAUCN080610000000003","LAUCN080630000000003","LAUCN080650000000003","LAUCN080670000000003","LAUCN080690000000003","LAUCN080710000000003","LAUCN080730000000003","LAUCN080750000000003","LAUCN080770000000003","LAUCN080790000000003","LAUCN080810000000003","LAUCN080830000000003","LAUCN080850000000003","LAUCN080870000000003","LAUCN080890000000003","LAUCN080910000000003","LAUCN080930000000003","LAUCN080950000000003","LAUCN080970000000003","LAUCN080990000000003","LAUCN081010000000003","LAUCN081030000000003","LAUCN081050000000003","LAUCN081070000000003","LAUCN081090000000003","LAUCN081110000000003","LAUCN081130000000003","LAUCN081150000000003","LAUCN081170000000003","LAUCN081190000000003","LAUCN081210000000003","LAUCN081230000000003","LAUCN081250000000003","LAUCN999999999999999")

payload = list(
  'seriesid'= "LAUCN080010000000003",
  'startyear'= 2015,
  'endyear'= 2016,
  'annualaverage'= TRUE,
  'registrationKey'= "2e936e05134e4b30978165309104d46b"
)

response= blsAPI(payload,2,return.data.frame = TRUE)

collector=response

for (i in counties){
  
  payload_loop = list(
    'seriesid'= i,
    'startyear'= 2015,
    'endyear'= 2016,
    'annualaverage'= TRUE,
    'registrationKey'= "2e936e05134e4b30978165309104d46b"
  )
  
  response_loop=blsAPI(payload_loop,2,return.data.frame = TRUE)
  
  collector=bind_rows(collector, response_loop)
  
}

output=collector%>%
  filter(!grepl("Annual", periodName))%>%
  group_by(seriesID)%>%
  summarize(unemp_avg=mean(as.numeric(value)))%>%
  mutate(countyfips=stringr::str_sub(seriesID,8,10))%>%
  filter(countyfips!="000")

jsonlite::write_json(output, "bls_unemp_avg.json")
